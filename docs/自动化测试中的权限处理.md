# 自动化测试中的权限处理

## 一、问题分析

### 1.1 用户疑问

**问题**：如果后续使用这个APP来测试其它应用时，每次启动也都需要手动授权，才能捕获屏幕？还是可以自动处理？

### 1.2 答案

**简短回答**：
- ✅ **第一次启动**：需要手动授权一次（系统要求）
- ✅ **同一会话内**：可以自动处理，无需重复授权
- ⚠️ **应用重启**：需要重新授权（系统安全机制）

---

## 二、权限处理机制

### 2.1 MediaProjection 权限特性

**Android 系统的 MediaProjection 权限机制：**

1. **一次性授权**：每次应用启动后，需要用户手动授权一次
2. **会话内复用**：授权后，在同一个应用会话中（应用不关闭），可以重复使用
3. **应用重启后失效**：应用关闭或重启后，需要重新授权

**这是 Android 系统的安全机制，无法绕过。**

### 2.2 自动化测试场景

**理想流程：**

```
1. 用户启动 TestWings 应用
   ↓
2. 第一次点击"开始测试"或"捕获屏幕"
   ↓
3. 弹出授权弹窗（用户授权一次）
   ↓
4. TestWings 保存 MediaProjection 实例
   ↓
5. 在整个测试过程中，持续使用该实例
   ↓
6. 无需重复授权，可以自动捕获屏幕
   ↓
7. 测试完成，应用可以继续运行
   ↓
8. 下次测试时，如果应用未重启，仍然可以使用（无需重新授权）
```

**实际情况：**

- ✅ **同一会话内**：授权一次后，可以持续使用，无需重复授权
- ⚠️ **应用重启**：需要重新授权（系统要求）
- ⚠️ **系统杀死应用**：需要重新授权（系统要求）

---

## 三、优化方案

### 3.1 当前实现

**已优化的功能：**

1. ✅ **保存 MediaProjection 实例**：在同一个应用会话中复用
2. ✅ **自动检查权限**：如果没有有效实例，自动请求权限
3. ✅ **避免重复授权**：同一会话内不会重复弹出授权弹窗

### 3.2 自动化测试最佳实践

**推荐流程：**

#### 方案 1：测试前授权（推荐）

```
1. 启动 TestWings 应用
2. 点击"开始测试"或执行第一个测试用例
3. 第一次会弹出授权弹窗，用户授权一次
4. 之后的所有测试用例都可以自动执行，无需重复授权
5. 应用保持运行，可以持续测试多个用例
```

**优点**：
- ✅ 用户只需要授权一次
- ✅ 后续测试完全自动化
- ✅ 用户体验好

#### 方案 2：应用启动时预授权

```
1. 启动 TestWings 应用
2. 应用检测到没有有效的 MediaProjection
3. 自动弹出授权弹窗（在测试开始前）
4. 用户授权后，应用保存实例
5. 后续所有测试都可以自动执行
```

**优点**：
- ✅ 在测试开始前就完成授权
- ✅ 测试过程中不会中断
- ✅ 更流畅的用户体验

---

## 四、实际使用场景

### 4.1 场景 1：单次测试

**流程：**
1. 启动 TestWings
2. 选择测试用例
3. 点击"开始测试"
4. **第一次**：弹出授权弹窗，用户授权
5. 测试自动执行，持续捕获屏幕
6. 测试完成

**授权次数**：1 次

### 4.2 场景 2：批量测试

**流程：**
1. 启动 TestWings
2. 选择多个测试用例
3. 点击"开始测试"
4. **第一次**：弹出授权弹窗，用户授权
5. 所有测试用例自动执行，持续捕获屏幕
6. 所有测试完成

**授权次数**：1 次（整个批量测试过程中）

### 4.3 场景 3：多次测试（应用保持运行）

**流程：**
1. 启动 TestWings
2. 第一次测试：授权一次
3. 测试完成，应用保持运行
4. 第二次测试：**无需重新授权**，直接执行
5. 第三次测试：**无需重新授权**，直接执行
6. ...

**授权次数**：1 次（只要应用不重启）

### 4.4 场景 4：应用重启后测试

**流程：**
1. 启动 TestWings（应用重启）
2. 选择测试用例
3. 点击"开始测试"
4. **需要重新授权**（系统要求）
5. 测试自动执行

**授权次数**：每次应用重启后需要重新授权

---

## 五、技术实现

### 5.1 屏幕捕获管理器

**创建了 `ScreenCaptureManager` 类：**

- ✅ 管理 MediaProjection 实例
- ✅ 自动检查权限状态
- ✅ 提供统一的权限请求接口
- ✅ 在同一个应用会话中复用实例

### 5.2 权限检查流程

```kotlin
// 伪代码
fun captureScreen() {
    // 1. 检查是否有有效的 MediaProjection
    if (screenCaptureManager.hasValidMediaProjection()) {
        // 2. 有，直接使用（无需重新授权）
        val mediaProjection = screenCaptureManager.getMediaProjection()
        // 执行屏幕捕获
    } else {
        // 3. 没有，请求权限
        screenCaptureManager.requestPermission()
        // 等待用户授权后，在回调中继续执行
    }
}
```

### 5.3 自动化测试集成

**在测试执行引擎中：**

```kotlin
// 伪代码
class TestExecutor {
    fun executeTestCase(testCase: TestCase) {
        // 1. 确保屏幕捕获权限已授权
        if (!screenCaptureManager.hasValidMediaProjection()) {
            // 请求权限（第一次）
            screenCaptureManager.requestPermission()
            // 等待授权后继续
            return
        }
        
        // 2. 执行测试步骤
        for (step in testCase.steps) {
            // 2.1 捕获屏幕（无需重新授权）
            val screenshot = captureScreen()
            
            // 2.2 分析屏幕
            val screenState = analyzeScreen(screenshot)
            
            // 2.3 执行操作
            executeAction(step)
            
            // 2.4 验证结果
            verifyResult(step)
        }
    }
}
```

---

## 六、总结

### 6.1 回答用户问题

**Q: 每次启动也都需要手动授权，才能捕获屏幕？还是可以自动处理？**

**A:**
- ✅ **第一次启动**：需要手动授权一次（系统要求）
- ✅ **同一会话内**：可以自动处理，无需重复授权
- ⚠️ **应用重启**：需要重新授权（系统安全机制）

### 6.2 实际使用建议

**最佳实践：**

1. **测试前授权**：
   - 启动 TestWings
   - 第一次测试时授权一次
   - 后续所有测试都可以自动执行

2. **保持应用运行**：
   - 测试完成后，不要关闭应用
   - 可以继续执行其他测试用例
   - 无需重复授权

3. **批量测试**：
   - 选择多个测试用例
   - 授权一次后，所有用例自动执行
   - 无需重复授权

### 6.3 系统限制

**无法避免的情况：**

- ⚠️ **应用重启**：需要重新授权（系统要求）
- ⚠️ **系统杀死应用**：需要重新授权（系统要求）
- ⚠️ **应用更新**：需要重新授权（系统要求）

**这些是 Android 系统的安全机制，无法绕过。**

---

## 七、未来优化方向

### 7.1 用户体验优化

1. **权限状态提示**：
   - 在测试开始前，检查权限状态
   - 如果未授权，提前提示用户
   - 提供"立即授权"按钮

2. **权限持久化提示**：
   - 在应用启动时，检查权限状态
   - 如果未授权，显示友好的提示
   - 引导用户完成授权

3. **权限失效检测**：
   - 检测 MediaProjection 是否失效
   - 如果失效，自动重新请求权限
   - 提供清晰的错误提示

### 7.2 自动化优化

1. **后台服务**：
   - 使用后台服务保持 MediaProjection 实例
   - 即使 Activity 被销毁，服务仍然运行
   - 延长权限有效期

2. **权限预检查**：
   - 在测试开始前，自动检查权限
   - 如果未授权，提前请求
   - 避免测试过程中的中断

---

**总结：在自动化测试场景中，用户只需要在第一次测试时授权一次，之后的所有测试都可以自动执行，无需重复授权。这是最佳的用户体验。**

