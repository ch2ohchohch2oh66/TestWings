# TestWings 权限说明

> 完整的权限说明，包括权限概述、授权机制、常见问题和最佳实践

## 一、权限概述

### 1.1 所需权限

TestWings 需要以下权限才能正常工作：

1. **屏幕捕获权限**（MediaProjection）- **必需**
2. **存储权限**（用于保存截图和测试结果）
3. **通知权限**（用于前台服务）

**注意**：TestWings采用纯视觉AI方案，**不依赖AccessibilityService权限**。

### 1.2 权限授权模式

**核心思路**：首次手动授权 + 后续自动操作

```
首次安装/首次使用
    ↓
用户手动授权（必须，无法绕过）
    └─ 屏幕捕获权限（MediaProjection）
    ↓
授权完成后
    ↓
AI 可以自动操作（完全自动化）
    ├─ 实时捕获屏幕
    ├─ Vision-Language模型理解屏幕
    ├─ AI 理解屏幕内容
    ├─ 智能元素定位
    └─ 自动执行操作
```

**关键点**：
- ✅ 授权后，AI 可以**完全自动**操作
- ✅ 不需要用户再次手动授权（除非应用重启且 MediaProjection 失效）
- ✅ AI 可以实时看到屏幕，理解内容，自动操作

---

## 二、屏幕捕获权限（MediaProjection）

### 2.1 权限特性

**MediaProjection 是 Android 系统提供的一次性权限机制：**

- ✅ **安全性**：每次应用启动后需要重新授权，防止恶意应用长期监控屏幕
- ✅ **用户控制**：用户每次都可以选择是否授权
- ✅ **会话内复用**：授权后，在同一个应用会话中可以重复使用，无需重复授权

### 2.2 授权行为

**正常情况：**
- 应用启动后，**第一次**点击"捕获屏幕"会弹出授权弹窗
- 授权后，在**同一个应用会话中**（不关闭应用），再次点击"捕获屏幕"**不会**弹出授权弹窗
- 关闭应用后重新打开，需要**重新授权**

**这是 Android 系统的安全机制，完全正常！**

### 2.3 优化说明

TestWings 已经优化了权限使用：
- 保存 MediaProjection 实例，在同一个应用会话中复用
- 避免在同一个会话中重复弹出授权弹窗
- 应用重启后仍然需要重新授权（系统要求）
- **授权弹窗延迟优化**：
  - 如果前台服务已在运行，授权弹窗立即显示（0 延迟）
  - 如果前台服务未运行，延迟 500ms 后显示授权弹窗
  - 授权后捕获延迟优化到 500ms

### 2.4 权限状态检查

**当前实现：**
- 每次点击"捕获屏幕"时检查是否有有效的 MediaProjection 实例
- 如果没有，则请求授权
- 如果有，则直接使用（无需重新授权）

---

## 三、权限处理机制

### 3.1 MediaProjection 生命周期

```
应用启动
  ↓
第一次点击"捕获屏幕"
  ↓
弹出授权弹窗（用户授权）
  ↓
创建 MediaProjection 实例
  ↓
保存实例（同一会话内复用）
  ↓
后续截图直接使用（无需重新授权）
  ↓
应用关闭
  ↓
MediaProjection 实例失效
  ↓
下次启动需要重新授权
```

### 3.2 自动化测试场景

**理想流程：**

```
1. 用户启动 TestWings 应用
   ↓
2. 第一次点击"开始测试"或"捕获屏幕"
   ↓
3. 弹出授权弹窗（用户授权一次）
   ↓
4. TestWings 保存 MediaProjection 实例
   ↓
5. 在整个测试过程中，持续使用该实例
   ↓
6. 无需重复授权，可以自动捕获屏幕
   ↓
7. 测试完成，应用可以继续运行
   ↓
8. 下次测试时，如果应用未重启，仍然可以使用（无需重新授权）
```

**实际情况：**
- ✅ **同一会话内**：授权一次后，可以持续使用，无需重复授权
- ⚠️ **应用重启**：需要重新授权（系统要求）
- ⚠️ **系统杀死应用**：需要重新授权（系统要求）

---

## 四、实际使用场景

### 4.1 场景 1：单次测试

**流程：**
1. 启动 TestWings
2. 选择测试用例
3. 点击"开始测试"
4. **第一次**：弹出授权弹窗，用户授权
5. 测试自动执行，持续捕获屏幕
6. 测试完成

**授权次数**：1 次

### 4.2 场景 2：批量测试

**流程：**
1. 启动 TestWings
2. 选择多个测试用例
3. 点击"开始测试"
4. **第一次**：弹出授权弹窗，用户授权
5. 所有测试用例自动执行，持续捕获屏幕
6. 所有测试完成

**授权次数**：1 次（整个批量测试过程中）

### 4.3 场景 3：多次测试（应用保持运行）

**流程：**
1. 启动 TestWings
2. 第一次测试：授权一次
3. 测试完成，应用保持运行
4. 第二次测试：**无需重新授权**，直接执行
5. 第三次测试：**无需重新授权**，直接执行
6. ...

**授权次数**：1 次（只要应用不重启）

### 4.4 场景 4：应用重启后测试

**流程：**
1. 启动 TestWings
2. 第一次测试：授权一次
3. 关闭应用
4. 重新启动 TestWings
5. 第二次测试：**需要重新授权**（系统要求）

**授权次数**：每次应用重启后需要重新授权

---

## 五、常见问题

### Q1: 为什么每次点击"捕获屏幕"都弹出授权弹窗？

**A:** 可能的原因：
1. **应用被重启**：如果应用被系统杀死后重新启动，需要重新授权
2. **MediaProjection 失效**：如果 MediaProjection 实例被系统回收，需要重新授权
3. **首次使用**：第一次使用需要授权

**解决方法：**
- 确保应用在后台运行（不要完全关闭）
- 在同一个应用会话中，第二次及以后的截图不会弹出授权弹窗

### Q2: 能否避免这些权限请求？

**A:** 不能，这是 Android 系统的安全机制：
- **屏幕捕获权限**：系统要求每次应用启动后重新授权

**这些限制是为了保护用户安全和隐私，无法绕过。**

### Q3: 为什么需要手动授权？能否自动授权？

**A:** 不能，这是 Android 系统的安全机制：
- 系统要求用户必须手动点击授权弹窗
- 这是为了防止恶意应用偷偷录制屏幕
- 所有自动化测试工具都需要用户首次手动授权

**这是保护用户隐私和安全的重要机制。**

### Q4: 授权后，AI能否自动操作？

**A:** 可以！授权完成后：
- ✅ AI 可以实时捕获屏幕
- ✅ AI 可以理解屏幕内容
- ✅ AI 可以自动执行操作
- ✅ 完全自动化，无需用户干预

---

## 六、最佳实践

### 6.1 屏幕捕获

1. **首次使用**：点击"捕获屏幕"，授权后即可使用
2. **后续使用**：在同一个应用会话中，直接点击"捕获屏幕"即可（无需重新授权）
3. **应用重启**：需要重新授权（系统要求）

### 6.2 自动化测试

**推荐流程：**

#### 方案 1：测试前授权（推荐）

```
1. 启动 TestWings 应用
2. 点击"开始测试"或执行第一个测试用例
3. 第一次会弹出授权弹窗，用户授权一次
4. 之后的所有测试用例都可以自动执行，无需重复授权
5. 应用保持运行，可以持续测试多个用例
```

**优点**：
- ✅ 用户只需要授权一次
- ✅ 后续测试完全自动化
- ✅ 用户体验好

#### 方案 2：应用启动时预授权

```
1. 启动 TestWings 应用
2. 应用检测到没有有效的 MediaProjection
3. 自动弹出授权弹窗（在测试开始前）
4. 用户授权后，应用保存实例
5. 后续所有测试都可以自动执行
```

**优点**：
- ✅ 在测试开始前就完成授权
- ✅ 测试过程中不会中断
- ✅ 更流畅的用户体验

---

## 七、技术实现

### 7.1 权限状态检测

```kotlin
// 检测屏幕捕获权限
fun isScreenCaptureAuthorized(): Boolean {
    return mediaProjection != null && mediaProjection?.isValid == true
}

// 检测所有权限是否就绪
fun areAllPermissionsReady(): Boolean {
    return isScreenCaptureAuthorized()
}
```

### 7.2 智能权限引导

```kotlin
// 权限引导流程
fun checkPermissionsAndGuide() {
    if (!areAllPermissionsReady()) {
        // 显示权限引导界面
        showPermissionGuide(
            needScreenCapture = !isScreenCaptureAuthorized()
        )
    } else {
        // 所有权限已就绪，可以开始自动化操作
        startAutomatedTesting()
    }
}
```

### 7.3 自动化操作流程（授权后）

```kotlin
// AI 自动化操作流程
fun executeAutomatedTest(testCase: TestCase) {
    // 1. 捕获屏幕（已授权，无需再次授权）
    val screenshot = captureScreen()
    
    // 2. Vision-Language模型理解屏幕
    val screenState = vlModel.understand(screenshot)
    
    // 3. LLM根据用例和屏幕状态制定策略
    val action = llm.planAction(testCase, screenState)
    
    // 4. 执行操作
    executeAction(action)
    
    // 5. 验证结果
    verifyResult(action, screenState)
}
```

---

## 八、总结

### 8.1 权限授权模式

**不是死循环，而是"首次手动授权 + 后续自动操作"的混合模式：**

1. **首次授权**：用户必须手动授权一次（系统要求，无法绕过）
2. **后续自动**：授权后，AI 可以完全自动操作，无需再次授权
3. **应用重启**：需要重新授权（系统安全机制）

### 8.2 核心要点

1. ✅ **屏幕捕获权限**：每次应用启动后需要重新授权（系统要求）
2. ✅ **纯视觉方案**：不依赖AccessibilityService，简化了权限管理
3. ✅ **授权后自动化**：授权完成后，AI 可以完全自动操作

**这些限制是为了保护用户安全和隐私，无法绕过，也不应该绕过。**

---

**如有其他问题，请查看日志或联系开发者。**

