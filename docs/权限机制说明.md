# TestWings 权限机制说明

## 一、权限概述

TestWings 需要以下权限才能正常工作：

1. **屏幕捕获权限**（MediaProjection）
2. **无障碍服务权限**（AccessibilityService）
3. **存储权限**（用于保存截图和测试结果）
4. **通知权限**（用于前台服务）

---

## 二、屏幕捕获权限（MediaProjection）

### 2.1 权限特性

**MediaProjection 是 Android 系统提供的一次性权限机制：**

- ✅ **安全性**：每次应用启动后需要重新授权，防止恶意应用长期监控屏幕
- ✅ **用户控制**：用户每次都可以选择是否授权
- ✅ **会话内复用**：授权后，在同一个应用会话中可以重复使用，无需重复授权

### 2.2 授权行为

**正常情况：**
- 应用启动后，**第一次**点击"捕获屏幕"会弹出授权弹窗
- 授权后，在**同一个应用会话中**（不关闭应用），再次点击"捕获屏幕"**不会**弹出授权弹窗
- 关闭应用后重新打开，需要**重新授权**

**这是 Android 系统的安全机制，完全正常！**

### 2.3 优化说明

TestWings 已经优化了权限使用：
- 保存 MediaProjection 实例，在同一个应用会话中复用
- 避免在同一个会话中重复弹出授权弹窗
- 应用重启后仍然需要重新授权（系统要求）
- **授权弹窗延迟优化**：
  - 如果前台服务已在运行，授权弹窗立即显示（0 延迟）
  - 如果前台服务未运行，延迟 500ms 后显示授权弹窗（从原来的 3.5 秒优化）
  - 授权后捕获延迟优化到 500ms（从原来的 1.5 秒优化）

---

## 三、无障碍服务权限（AccessibilityService）

### 3.1 权限特性

**无障碍服务权限是系统级权限：**

- ✅ **持久性**：一旦授权，会一直保持有效
- ✅ **安全性**：应用更新（重新安装）后，系统会撤销权限
- ✅ **用户控制**：用户可以在系统设置中随时开启/关闭

### 3.2 授权行为

**正常情况（标准 Android）：**
- **首次安装**：需要在系统设置中手动开启
- **应用更新**：更新后需要**重新授权**（系统安全机制）
- **应用卸载重装**：需要**重新授权**
- **应用重启**：权限保持有效（服务继续运行）

**特殊行为（HarmonyOS/华为设备）：**
- **APP 被杀死后重启**：系统可能会**自动关闭**无障碍服务
- 这是 HarmonyOS 的安全机制，用于防止后台应用滥用权限
- **解决方法**：需要重新在系统设置中开启，或配置自启动权限

**这是系统的安全机制，完全正常！**

### 3.3 为什么更新后需要重新授权？

**系统安全考虑：**
1. **防止恶意更新**：如果应用被恶意更新，系统会撤销权限，保护用户安全
2. **权限验证**：系统需要验证新版本应用的签名和权限配置
3. **用户确认**：确保用户知道新版本应用仍然需要无障碍权限

---

## 四、权限状态检查

### 4.1 屏幕捕获权限

**当前实现：**
- 每次点击"捕获屏幕"时检查是否有有效的 MediaProjection 实例
- 如果没有，则请求授权
- 如果有，则直接使用（无需重新授权）

### 4.2 无障碍服务权限

**当前实现：**
- 应用启动时自动检查无障碍服务状态
- 界面实时显示服务状态（✅ 已启用 / ❌ 未启用）
- 提供"前往设置开启"按钮，方便用户授权

---

## 五、常见问题

### Q1: 为什么每次点击"捕获屏幕"都弹出授权弹窗？

**A:** 可能的原因：
1. **应用被重启**：如果应用被系统杀死后重新启动，需要重新授权
2. **MediaProjection 失效**：如果 MediaProjection 实例被系统回收，需要重新授权
3. **首次使用**：第一次使用需要授权

**解决方法：**
- 确保应用在后台运行（不要完全关闭）
- 在同一个应用会话中，第二次及以后的截图不会弹出授权弹窗

### Q2: 为什么应用更新后需要重新开启无障碍服务？

**A:** 这是 Android 系统的安全机制：
- 系统会验证新版本应用的签名和权限配置
- 确保用户知道新版本应用仍然需要无障碍权限
- 防止恶意应用通过更新获得权限

**解决方法：**
- 更新后，在应用界面点击"前往设置开启"
- 或者在系统设置中手动开启

### Q3: 能否避免这些权限请求？

**A:** 不能，这是 Android 系统的安全机制：
- **屏幕捕获权限**：系统要求每次应用启动后重新授权
- **无障碍服务权限**：系统要求应用更新后重新授权

**这些限制是为了保护用户安全和隐私，无法绕过。**

### Q4: 为什么杀掉APP后，无障碍服务会被关闭？（HarmonyOS/华为设备）

**A:** 这是 HarmonyOS/华为设备的安全机制：
- 当APP被强制杀死后，系统可能会自动关闭无障碍服务
- 这是为了防止后台应用滥用权限
- **这是系统级别的行为，无法通过代码绕过**

**解决方法：**
1. **重新开启**：在系统设置中重新开启无障碍服务
2. **设置自启动权限**：在"设置 → 应用管理 → TestWings → 自启动"中开启自启动权限
3. **关闭电池优化**：在"设置 → 电池 → 电池优化"中，将 TestWings 设置为"不允许"
4. **锁定后台**：在最近任务中，下拉 TestWings 卡片，点击锁定图标

**注意**：即使设置了这些，系统仍可能在极端情况下（如内存不足）关闭服务。

---

## 六、最佳实践

### 6.1 屏幕捕获

1. **首次使用**：点击"捕获屏幕"，授权后即可使用
2. **后续使用**：在同一个应用会话中，直接点击"捕获屏幕"即可（无需重新授权）
3. **应用重启**：需要重新授权（系统要求）

### 6.2 无障碍服务

1. **首次安装**：在应用界面点击"前往设置开启"，或手动在系统设置中开启
2. **应用更新**：更新后需要重新开启（系统要求）
3. **检查状态**：应用界面会实时显示服务状态
4. **HarmonyOS/华为设备**：
   - 如果APP被杀死后服务被关闭，需要重新开启
   - 建议设置自启动权限和关闭电池优化，以减少服务被关闭的概率

---

## 七、技术细节

### 7.1 MediaProjection 生命周期

```
应用启动
  ↓
第一次点击"捕获屏幕"
  ↓
弹出授权弹窗（用户授权）
  ↓
创建 MediaProjection 实例
  ↓
保存实例（同一会话内复用）
  ↓
后续截图直接使用（无需重新授权）
  ↓
应用关闭
  ↓
MediaProjection 实例失效
  ↓
下次启动需要重新授权
```

### 7.2 AccessibilityService 生命周期

```
应用安装
  ↓
用户在系统设置中开启
  ↓
服务启动，权限生效
  ↓
应用更新
  ↓
系统撤销权限（安全机制）
  ↓
用户重新开启
  ↓
服务重新启动，权限恢复
```

---

## 八、HarmonyOS/华为设备特殊说明

### 8.1 无障碍服务被自动关闭

**现象：**
- APP 被杀死后重新启动，无障碍服务在系统设置中被关闭
- 需要重新在系统设置中开启

**原因：**
- HarmonyOS/华为设备的安全机制
- 系统在检测到APP被强制杀死后，可能会自动关闭无障碍服务
- 这是系统级别的行为，无法通过代码绕过

**解决方案（推荐按顺序尝试）：**

#### 方案1：设置自启动权限（最有效）✅
- 打开"设置 → 应用管理 → TestWings"
- 找到"自启动"选项，**开启自启动权限**
- **这是最有效的解决方案，设置后通常可以解决问题**

#### 方案2：关闭电池优化
- 打开"设置 → 电池 → 电池优化"
- 找到 TestWings，设置为"不允许"

#### 方案3：锁定后台
- 打开最近任务（多任务界面）
- 找到 TestWings 卡片，向下滑动
- 点击锁定图标（锁形图标）

#### 方案4：重新开启服务
- 如果服务被关闭，在应用界面点击"前往设置开启"
- 或在系统设置中手动开启

**注意**：即使设置了这些，系统仍可能在极端情况下（如内存严重不足）关闭服务。

---

## 九、总结

**这些行为都是系统的安全机制，完全正常：**

1. ✅ **屏幕捕获权限**：每次应用启动后需要重新授权（系统要求）
2. ✅ **无障碍服务权限**：
   - **标准 Android**：应用更新后需要重新授权（系统要求）
   - **HarmonyOS/华为设备**：APP被杀死后可能被自动关闭（系统安全机制）

**这些限制是为了保护用户安全和隐私，无法绕过，也不应该绕过。**

---

**如有其他问题，请查看日志或联系开发者。**

