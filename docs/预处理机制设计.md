# 预处理机制设计

## 一、设计理念

### 1.1 核心思想

**预处理 + 实时识别 = 高效准确**

在执行测试前，测试工程师提供页面截图，由大模型预处理识别所有元素。执行时优先使用预处理结果，提升速度和准确率。

### 1.2 优势

1. **提升执行速度**：预处理结果缓存，无需实时识别
2. **提高准确率**：完整页面截图（包含滚动内容），识别更全面
3. **减少计算开销**：避免重复识别相同页面
4. **支持离线执行**：预处理完成后，可离线执行测试
5. **测试工程师可控**：由测试工程师提供截图，确保准确性

### 1.3 工作流程

**测试工程师**：
1. 准备页面截图（按命名规范）
2. 提供截图元数据信息
3. 提交预处理请求

**系统**：
1. 接收截图和元数据
2. VL模型预处理识别
3. 存储预处理结果
4. 执行时匹配使用

---

## 二、预处理流程

### 2.1 预处理阶段

```
1. 准备页面截图
   ├─ 静态页面：单张截图
   └─ 可滚动页面：滚动截图（完整页面）
   ↓
2. 大模型预处理
   ├─ Vision-Language模型分析
   ├─ 识别所有文字块（坐标、内容）
   ├─ 识别所有可操作元素（按钮、输入框等）
   └─ 生成结构化数据
   ↓
3. 存储预处理结果
   ├─ 页面标识（页面特征、URL等）
   ├─ 元素列表（位置、类型、内容）
   └─ 元数据（截图时间、版本等）
```

### 2.2 执行阶段

```
执行测试步骤
  ↓
匹配当前屏幕与预处理页面
  ├─ 成功匹配：使用预处理结果
  └─ 未匹配：实时识别（OCR/VL）
  ↓
执行操作
```

---

## 三、预处理截图规范

### 3.1 命名规范

**文件命名格式**：
```
{app_name}_{page_name}_{scenario_name}_{version}.png
```

**示例**：
```
wechat_main_home_v1.0.png          # 微信主界面
wechat_chat_list_default_v1.0.png  # 微信聊天列表（默认场景）
wechat_chat_list_empty_v1.0.png     # 微信聊天列表（空列表场景）
meeting_join_room_v1.0.png          # 会议加入房间页面
meeting_recording_active_v1.0.png   # 会议录制中页面
```

**命名规则说明**：
- `app_name`：应用名称（小写，下划线分隔）
- `page_name`：页面名称（小写，下划线分隔）
- `scenario_name`：场景名称（可选，如default、empty、error等）
- `version`：版本号（如v1.0、v2.0等）

### 3.2 元数据信息

**必需信息**（JSON格式，与截图同名）：
```json
{
  "app_name": "wechat",
  "app_display_name": "微信",
  "page_name": "main",
  "page_display_name": "主界面",
  "scenario_name": "home",
  "scenario_display_name": "默认首页",
  "version": "1.0",
  "description": "微信主界面，包含底部导航栏和聊天列表",
  "key_features": {
    "key_texts": ["微信", "聊天", "发现", "我"],
    "key_elements": ["底部导航栏", "聊天列表", "搜索框"]
  },
  "screenshot_type": "static",  // static: 静态页面, scroll: 滚动截图
  "scroll_direction": null,     // 滚动方向（如scroll时使用）
  "created_at": "2024-01-01T10:00:00Z",
  "created_by": "测试工程师姓名"
}
```

**可选信息**：
```json
{
  "tags": ["首页", "导航", "常用页面"],
  "related_pages": ["wechat_chat_detail", "wechat_discover"],
  "notes": "此页面在登录后显示"
}
```

### 3.3 目录结构

**建议目录结构**：
```
preprocess/
├── screenshots/
│   ├── wechat/
│   │   ├── wechat_main_home_v1.0.png
│   │   ├── wechat_main_home_v1.0.json
│   │   ├── wechat_chat_list_default_v1.0.png
│   │   └── wechat_chat_list_default_v1.0.json
│   └── meeting/
│       ├── meeting_join_room_v1.0.png
│       └── meeting_join_room_v1.0.json
└── results/
    ├── wechat_main_home_v1.0_preprocessed.json
    └── meeting_join_room_v1.0_preprocessed.json
```

---

## 四、预处理数据结构

### 4.1 页面标识

```json
{
  "page_id": "wechat_main_home_v1.0",
  "app_name": "wechat",
  "app_display_name": "微信",
  "page_name": "main",
  "page_display_name": "主界面",
  "scenario_name": "home",
  "scenario_display_name": "默认首页",
  "version": "1.0",
  "screenshot_path": "/preprocess/screenshots/wechat/wechat_main_home_v1.0.png",
  "metadata_path": "/preprocess/screenshots/wechat/wechat_main_home_v1.0.json",
  "page_features": {
    "key_texts": ["微信", "聊天", "发现", "我"],
    "key_elements": ["底部导航栏", "聊天列表"]
  }
}
```

### 4.2 元素列表

```json
{
  "elements": [
    {
      "type": "button",
      "text": "聊天",
      "position": {"x": 100, "y": 1800, "width": 200, "height": 50},
      "confidence": 0.95,
      "action": "click"
    },
    {
      "type": "text",
      "content": "微信",
      "position": {"x": 200, "y": 50},
      "confidence": 0.98
    },
    {
      "type": "input",
      "hint": "搜索",
      "position": {"x": 50, "y": 100, "width": 600, "height": 60},
      "confidence": 0.92,
      "action": "input"
    }
  ]
}
```

---

## 五、用例与预处理截图匹配

### 5.1 用例中的页面引用

**自然语言用例**：
```
打开微信APP，进入主界面，点击"聊天"按钮
```

**结构化用例**（JSON）：
```json
{
  "name": "微信登录测试",
  "steps": [
    {
      "action": "open_app",
      "app": "微信"
    },
    {
      "action": "navigate",
      "page": "主界面",  // 页面名称
      "scenario": "默认首页"  // 场景名称（可选）
    },
    {
      "action": "click",
      "target": "聊天"
    }
  ]
}
```

### 5.2 匹配机制

**匹配策略**：
1. **精确匹配**：用例中的页面名称与预处理截图的`page_display_name`完全匹配
2. **场景匹配**：用例中的场景名称与预处理截图的`scenario_display_name`匹配
3. **语义匹配**：使用AI理解用例中的页面描述，匹配预处理截图
4. **特征匹配**：比较屏幕特征（关键文字、关键元素）

**匹配优先级**：
1. 精确匹配（页面名称 + 场景名称）
2. 精确匹配（仅页面名称）
3. 语义匹配（AI理解）
4. 特征匹配（屏幕特征）

### 5.3 匹配示例

**用例**：
```json
{
  "action": "navigate",
  "page": "主界面",
  "scenario": "默认首页"
}
```

**匹配过程**：
1. 查找`page_display_name = "主界面"`且`scenario_display_name = "默认首页"`的预处理截图
2. 找到：`wechat_main_home_v1.0`
3. 使用预处理结果

**用例**（自然语言）：
```
打开微信，进入聊天列表页面
```

**匹配过程**：
1. AI理解：页面名称="聊天列表"
2. 查找`page_display_name = "聊天列表"`的预处理截图
3. 找到：`wechat_chat_list_default_v1.0`
4. 使用预处理结果

---

## 六、匹配策略

### 6.1 页面匹配

**匹配方式**：
1. **特征匹配**：比较关键文字、关键元素
2. **图像匹配**：比较屏幕截图与预处理截图
3. **混合匹配**：结合特征和图像匹配

**匹配阈值**：
- 相似度 > 0.8：完全匹配，使用预处理结果
- 相似度 0.5-0.8：部分匹配，使用预处理结果 + 实时识别补充
- 相似度 < 0.5：未匹配，完全使用实时识别

### 6.2 元素匹配

**匹配方式**：
1. **位置匹配**：元素位置是否一致
2. **内容匹配**：元素内容是否一致
3. **类型匹配**：元素类型是否一致

**匹配失败处理**：
- 元素位置变化：使用内容匹配重新定位
- 元素内容变化：使用实时识别
- 元素不存在：使用实时识别

---

## 七、滚动截图处理

### 5.1 滚动截图生成

**方式**：
1. 自动滚动并截图
2. 拼接多张截图
3. 生成完整页面截图

**技术**：
- 使用Accessibility Service或坐标滑动
- 图像拼接算法
- 去除重复区域

### 5.2 预处理滚动截图

**优势**：
- 识别完整页面内容
- 包含所有可滚动元素
- 提高元素定位准确率

**处理**：
- Vision-Language模型分析完整截图
- 识别所有元素（包括滚动区域）
- 记录元素在完整页面中的位置

---

## 八、实时识别降级

### 8.1 降级策略

**优先级**：
1. **预处理结果**（优先使用）
2. **实时VL识别**（预处理不匹配时）
3. **实时OCR识别**（VL不可用时，可选）

### 8.2 降级条件

**使用实时识别的情况**：
- 预处理结果未匹配
- 预处理结果过期（页面已更新）
- 预处理结果不完整
- 需要识别动态内容

---

## 九、实施建议

### 9.1 预处理工具

**独立工具**：
- 页面截图工具
- 预处理服务（调用VL模型）
- 预处理结果管理工具

### 9.2 集成方式

**方式1：测试前预处理**
- 测试执行前，预处理所有页面
- 预处理结果存储在本地或云端

**方式2：按需预处理**
- 首次遇到页面时预处理
- 预处理结果缓存

**方式3：混合方式**
- 关键页面预先处理
- 其他页面按需处理

---

## 十、优势总结

### 10.1 性能优势

- **速度提升**：预处理结果直接使用，无需实时识别
- **准确率提升**：完整页面截图，识别更全面
- **资源节省**：避免重复识别相同页面

### 10.2 功能优势

- **支持离线执行**：预处理完成后可离线执行
- **支持版本管理**：预处理结果可版本化
- **支持批量处理**：可批量预处理多个页面

---

## 十一、注意事项

### 11.1 页面变化处理

**问题**：页面更新后，预处理结果可能失效

**解决**：
- 版本管理：记录预处理结果版本
- 自动检测：检测页面变化，自动重新预处理
- 降级策略：预处理失效时自动降级到实时识别

### 11.2 动态内容处理

**问题**：动态内容无法预处理

**解决**：
- 静态元素使用预处理结果
- 动态内容使用实时识别
- 混合使用

---

## 十二、测试工程师工作流程

### 12.1 准备预处理截图

**步骤**：
1. 打开待测APP，导航到目标页面
2. 如果是可滚动页面，进行滚动截图（完整页面）
3. 保存截图，按命名规范命名
4. 创建元数据JSON文件（与截图同名）
5. 填写元数据信息（页面名称、场景名称等）
6. 提交预处理请求

### 12.2 命名规范检查清单

- ✅ 文件命名符合格式：`{app_name}_{page_name}_{scenario_name}_{version}.png`
- ✅ 页面名称与用例中的页面名称一致
- ✅ 场景名称清晰明确（如有多个场景）
- ✅ 版本号正确（页面更新时更新版本号）

### 12.3 元数据填写检查清单

- ✅ 必需信息完整（app_name、page_name、page_display_name等）
- ✅ 页面显示名称与用例中的页面名称一致
- ✅ 关键特征信息准确（key_texts、key_elements）
- ✅ 截图类型正确（static或scroll）

### 12.4 用例编写建议

**建议**：
- 用例中的页面名称使用`page_display_name`
- 场景名称使用`scenario_display_name`（如有）
- 保持命名一致性，便于匹配

**示例**：
```json
{
  "steps": [
    {
      "action": "navigate",
      "page": "主界面",  // 对应 page_display_name
      "scenario": "默认首页"  // 对应 scenario_display_name
    }
  ]
}
```

---

## 十三、总结

预处理机制是一个很好的优化，可以：
- ✅ 提升执行速度和准确率
- ✅ 减少实时计算开销
- ✅ 支持离线执行
- ✅ 提高用户体验

**建议**：作为核心优化功能，优先实施。

